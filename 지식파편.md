# Redis 도입을 통한 성능 개선

서비스의 성능은 여러 단계로 확인할 수 있다.

- 브라우저를 통해 직접 QA하며 전구간 테스트
- webpagetest 등을 통한 인터넷 구간만 테스트
- 부하 테스트로 (브라우저 렌더링을 제외한) 전구간을 테스트

nGrinder를 이용해 테스트를 진행한다.

<br>

## 테스트 시나리오 대상
가장 중요한 것은 **어떤 성능을 중점적으로 측정할 것인가?**  
사용자 트래픽이 많은 파트, 가장 중요한 파트를 측정하는게 효율적이다.
경쟁사이트 또는 유사 사이트의 성능을 조사해서 지표로 삼는 것도 좋다.
즉, 자기 서비스에 대한 이해가 우선 되어야 한다.

Babble 팀의 경우 채팅을 통한 실시간 대화가 주 서비스
-> 데이터베이스에 의존하고 있는 채팅-웹소켓의 속도가 주 관건이다.
다른 데이터들보다 생성, 조회, 삭제 행동이 자주 일어난다.
데이터베이스 관련 속도 측정, 성능 개선이 목표가 되면 좋다.

<br>

## 성능 목표
성능 목표를 지정하는 방법은 여러가지가 있지만, CU 강의에서 제시해주신 방법은 크게 3가지

1. DAU (1일 사용자 수)
2. 피크 시간대 집중률 (최대 트래픽 / 평소 트래픽)
3. 1명당 1일 평균 요청 수

3가지가 모두 합쳐져서 `Throughput: 1일 평균 rps ~ 1일 최대 rps`가 만들어진다.

계산 방법은 아래와 같다.

- 1일 사용자 수 (DAU) * 1명당 1일 평균 접속수 = 1일 총 접속수
- 1일 총 접속수 / 86,400 (초/일) = 1일 평균 rps
- 1일 평균 rps * (최대 트래픽/ 평소 트래픽) = 1일 최대 rps

<br>

## 초기 테스트 환경
- 유휴(채팅방을 이용 중이지 않은 대기 상태) 유저 수
- 채팅방에 참여중인 유저 수
- 채팅방 개수

<br>

# JPA equals and hashCode
```java
    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (!(o instanceof Member)) {
            return false;
        }
        Member member = (Member) o;
        return Objects.equals(getId(), member.getId());
    }

    @Override
    public int hashCode() {
        return Objects.hash(id);
    }
```

<br>

# java reflection
### getMethods()
상속한 메서드를 포함해서, 접근제한자가 public 인 메서드들만 가져온다.

```
Class<?> animalCLass = Student.class;
Method[] methods = animalClass.getMethods();

"toString", "getName", "getAge", 
"wait", "wait", "wait", "equals", "hashCode",
"getClass", "notify", "notifyAll"
```

별별 거 다 가져온다.

### getDeclaredMethods()
상속한 메서드를 제외하고, 접근제한자에 관계없이 직접 코드로 선언된 메서드들을 가져온다.

```
Class<?> animalClass = Student.class;
Method[] methods = animalClass.getDeclaredMethods();

"getAge", "toString", "getName"
```

getConstructor, getDeclaredConstructor도 마찬가지.

<br>

# Gradle
app모듈의 JwpApplication.java 의 addWebApp 메서드
https://files.slack.com/files-pri/TFELTJB7V-F02EGQH9KGX/image.png
https://files.slack.com/files-pri/TFELTJB7V-F02FM582LL8/image.png


17:18
app 모듈의 build.gradle
17:18
https://files.slack.com/files-pri/TFELTJB7V-F02F3NN0X0U/image.png


image.png


17:19
idea로 돌릴 시에 해당 루트에다가 결과물들을 만들게함

현구막(최현구)  17:19
아 저 설정 때문에
idea는 됐다?
그럼 gradle에도 저걸 가능하게 하면 되는건가??!!

파즈(강승윤)  17:19
image.png 
image.png

도릴니깐 생긴 폴더
그래들로 돌려서 바꾸고싶으면 그래들로 만들어서 생기는 루트를 설정해주면 읽혀질듯
idea로 해둔이유는 사람들이 intellij로 많이 돌리니깐
미션의 용이함을 위해서
저거를 설정해준거
근데 그래들로 돌리고 어떤 설정루트를 넣어야할지 몰라서 패쑤…

현구막(최현구)  17:20
파즈 탐구정신 엄청나네
파즈 가는 곳 따라가면 저도 마소에 도착할 수 있나요?
쩐다…
접근한 실마리는 뭐였어?

파즈(강승윤)  17:21
그냥 gradle 파일
설정들 찾아봣어
근데 idea 스코프 잇길레..

현구막(최현구)  17:21
대단..

파즈(강승윤)  17:21
어쨋든 정보공유 끝!
한가위 잘보내 구막!

<br>

# LogBack JPA query 설정
logback.xml 설정에서 JPA query는 application.yml 프로필의 hibernate 옵션 설정을 따른다.

<br>

# 홍정민 DBA님 특강 / QnA
## Key Point
### OLTP(Online Transaction Processing)
온라인 환경에선 트랜잭션이 길어지면 안 된다.
최대한 짧게 만들어야 한다.

### Transcation ACID
잘 아는 ACID 그것.

### MVCC(Multi-Version Concurrency Control)
다중 트랜잭션의 동시성을 제어하는 메커니즘

## QnA
> Q. DB 백업에 대해 구축해보려고 하고 있습니다. 현재는 mysqldump를 활용해서 1시간 간격으로 mysqldump를 활용해 스냅샷을 사용하는 방식으로 백업을 하고 있습니다. 하지만 만약에 13시에 백업이 완료되고 13시 30분에 DB의 전체 데이터가 손실되었다면, 13시와 13시 30분 사이에 있는 데이터들을 복구할 방법이 없다는 문제에 부딪혔습니다… 
> 
> 아무 시점에 DB가 날라가더라도 모든 데이터를 완벽하게 백업하려면 어떻게 DB 백업 시스템을 구축해야 할까요 ? 어떤 키워드로 공부하면 이러한 문제를 해결할 수 있을까요 ?
> 
> ---
>
> A. mysql binlog를 확인해보시면 좋을거 같아요. ...(생략)...

> Q. 도커를 이용한 데이터베이스 관리에서 데이터 영속성 부여를 어떻게 하면 될까요?
로컬 디렉토리와 볼륨 연결을 해두게 된다면 데이터베이스를 이전할 때 어떤 방법을 이용하면 될지 궁금합니다!!
> 
> ---
> 
> A. 데이터베이스 이전 과정에서 데이터손실이 발생할 수 있기 때문에 아직까지도 현업에서 컨테이너에 데이터베이스를 올리지 않습니다. 도커 컨테이너가 죽었을 때, 다른 컨테이너로 이전해야하는데, 어떻게 이전하면 될거라고 생각하시나요? ...(생략)...

> Q. MySQL을 사용하다가 인덱스를 사용한 조회쿼리를 날려보다가 어느순간 페이지를 몇개 안읽더라구요! 
혹시 MySQL 내부에서 기본적으로 쿼리도 캐싱을 하는걸까요?
>
> ---
> 
> A. 실제 내부에서 (물리메모리 70%까지도 설정 해서 쓰곤한다.) 메모리에 쿼리를 캐싱해두는 기능을 지원합니다. 그래서 자주 사용되는 쿼리문은 실제 데이터베이스 액세스를 하지 않고 결과를 반환합니다.
