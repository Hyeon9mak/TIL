# DAO 에서의 Optional

DAO 단에서 데이터 조회에 실패했을 때 예외처리를 어떻게 하느냐에 대해 크루들과 토론이 있었다.  
나는 크게 2가지 이유로 DAO에서 `Optional` 사용을 지양하는 편이었다.  

- 데이터 조회에 실패했다면 곧장 예외 상황으로 넘기면 될 걸, `Optional`이 추가 로직 가능성을 제공한다.
    - 추가 로직이 수행되는지 별도로 확인 작업을 거쳐야한다.
- JPA가 `Optional`을 사용한다.
    - JPA를 모방하기 위함인지, 실제로 조회 실패시 별도 로직을 수행하기 위함인지 구별하기 어렵다.

그런데 얼마전 제이(박준호)님께 DM으로 질문을 드리면서 `Optional`을 다른 관점에서 해석해보게 되었다.

> **[나]**  
> DAO exception 처리 관련 질문인데요,
> 중복된 이름으로 Station 신규 등록(`Dao.insert`)을 시도하려 할 때
> 
> - Service 단에서 `Dao.findByName` 조회를 통해 중복 데이터 임을 미리 잡아내기
> - `Dao.insert` 까지 시도한 후에 Uniq 옵션으로 인해 DuplicateKeyException 발생하면  
> 이걸 Catch해서 별도 exception을 다시 던지기
> 
> 개인적으로 후자는 DB Exception에 의존적인 구조를 가질거 같아서 전자로 시도해보려하는데, 
> 혹시나 후자가 더 나은 방법일까 고민되어서요..! 
> 또 전자로 수행하게 된다면, DAO쪽에 boolean 을 반환하는 Dao.isExist 등의 메서드를 생성해도 괜찮은지 궁금합니다! 
> 
> ---
> 
> **[제이(박준호)]**  
> 전 당연히 전자로 생각해요~ 이유는 현구님이 잘 말씀해주셨구요. 
> (그 뿐만아니라 서비스레이어를 테스트할때도 repository를 호출하는지 안하는지 테스트를 할 수도있습니다)  
> 
> 유스케이스를 생각했을때도 
> 
> - 전자 : `등록 -> 이름이 있다면 -> 예외`
> - 후자 : `등록 -> insert후 에러가 발생한다면 -> 예외`
>
> 당연히 전자가 이해도와 가독측면에서 앞섭니다.  
> 
> 그리고 전자로 수행했을시, 그냥 조회메서드로 조회해서 조회되는지만 봐도될거같아요.
> 다른곳에서 사용하는 `findByName(name)`을 호출해서 데이터가 발견되면 예외처리하면 되니까요.
> 만약 엔티티 필드 양이 너무나 방대해서 네트워크 통신비용을 잡아먹는다 싶으면 exists로 해도되긴하지만 미미할거에요 ㅎㅎ;  
> 추가적으로 전자의 조회비용은 키로 조회하기때문에 비용은 무시해도됩니다.
>
> ---
>
> **[나]**  
> 감사합니다!   
> "DAO쪽에 boolean 을 반환하는 Dao.isExist 등의 메서드를 생성해도 괜찮은지" 질문을 드린 이유는
> ![image](https://user-images.githubusercontent.com/37354145/121474888-abbbff00-c9ff-11eb-8df6-e03815fe980a.png)
> 이렇게 결국 DB의 Exception을 catch 하는 상황이 발생해서..  
> Dao에서 처리할 때 결점이 그대로 적용되는게 아닌가 생각되어서요..!
>
> ---
>
> **[제이(박준호)]**  
> 저거 catch해서 따로 처리해주시는게있나요?  
> ```java
> stationDao.findByName(name)
>   .ifPresent(satation -> throw new DupException(station.getname());
> ```
> 이런식으로 하면되지않나요??
>
> ---
>
> **[나]**  
> 아, `Optional`을 사용하면 될까요?
> `Optional`이 DB 조회에 실패했을 경우에도 추가 로직을 수행할 가능성을 보여준다고 생각해서 최대한 사용을 지양하려 했거든요..
>
> ---
>
> **[제이(박준호)]**  
> 아 `Optional` 사용을 안하셨군요~  
> 사실 레이어를 하나 더 두는게 맞긴한데, 현재 프로젝트 구조에서 너무 불필요하게 많아지니..  
> DAO에서 그냥 `Optional`로 처리 하라고 다른분들께는 리뷰를 드리긴했거든요.  
> 나중에 JPA를 사용하시면 접하시게되면 Repoistory라는걸 이용하게 될텐데, entity의 id가 없다면 
> `Optinoal`로 반환해서 처리를 많이 할거에요.
>
> ---
>
> **[나]**  
> 그렇지 않아도 얼마전에 이걸로 크루들간 토론이 있었는데
> 저는 “JPA가 `Optional`로 처리하기 때문에 더욱 `Optional`을 쓰면 안된다. 
> JPA를 모방하기 위함인지, 별도로 조회 실패시에도 로직을 수행시키기 위해 사용한것인지 구별이 어렵다.” 라고 의견을 내버렸어요…
>
> ---
>
> **[제이(박준호)]**  
> 오그렇게 생각하셨군요 저는 `Optional` 사용이 JPA를 모방한다고 생각 해보진 않았어요!  
> `내가 찾는게 없다 -> 예외` 로 볼거냐, `내가 찾는게 없다 -> 정상상황` 으로 볼거냐 
> 에 대한 처리를 비지니스 로직(Service 레이어) 에게 열어두는거죠.
> 무조건 예외터쳐버리면 실제 요구사항이 어떻든 예외를 잡아서 처리를해야하니까요.
>
> ---
>
> **[나]**  
> `Optional` 을 통해서 조회에 실패한 상황을 무조건 예외로 볼거냐, 비즈니스 로직으로 볼거냐 관점을 나눌 수 있군요..
>
> ---
>
> **[제이(박준호)]**  
> 실제로 요구사항중에서 `조회해서 있으면 -> A 저장`, `조회해서 없으면 -> B 저장`  
> 이런게 많습니다. 둘다 예외상황이 아닌거죠.  
> 저런경우에도 불필요하게 catch문을넣어서 로직을 태우면 가독이 심하게 떨어질거에요.
>
> ---
>
> **[나]**  
> 감사합니다!!
> '`내가 찾는게 없다 -> 예외` 로 볼거냐, `내가 찾는게 없다 -> 정상상황` 으로 볼거냐 
> 에 대한 처리를 비지니스로직에게 열어두는거죠'  
> 요 부분에서 새로운 관점이 트이는 기분이에요!
> 필요한 부분에 Optional 적극 시도해보겠습니다!

'`Optional`이 추가적인 로직 수행의 가능성을 열어버린다.' 처럼 부정적으로 바라보았는데,  
'조회 값이 없는것 자체가 예외가 아니다. `Optional`을 통해 비즈니스 로직에게 선택권을 준다.' 라고 
생각할 수 있게 되었다. (try-catch 문이 줄어드는 부가적인 효과도 누릴 수 있다!)

---

웨지의 추가 의견
- `Optional`이 DAO 조회 결과가 Null 일수도 있다는 걸 표현해준다는 장점도 있다.
- 그러나 사실 Nullable 개념 자체를 선호하진 않는다. 객체지향과 거리가 있어 보인다.
    - 객체지향은 객체에게 메세지를 던졌을 때 객체의 상태에 알맞는 동작 결과를 반환 받는 것
    - `Optional` 때문에 객체의 상태를 직접 캐내서 `if/else`를 사용하게 되는 느낌
    - 수동적인 코드가 작성된다.

---

물론 객체나 상태의 존재 자체가 없음을 표현하는 `null`의 특성도 생각해야하지만, 웨지 의견도 충분히 이해가 된다.

<br>

## 참고하면 좋을 포스트
- http://homoefficio.github.io/2019/10/03/Java-Optional-%EB%B0%94%EB%A5%B4%EA%B2%8C-%EC%93%B0%EA%B8%B0/